"""Architecture contract test to enforce provider-client + thin-source separation.

This test fails if any *_source.py directly imports networking, rate limiting,
or SDKs that should live in providers/*. It ensures future LLM edits follow
app/data_management/ARCHITECTURE.md.
"""

import ast
import importlib.util
from pathlib import Path
from typing import Set

import pytest


# Disallowed imports in data_sources/*_source.py (must live in providers/*)
DISALLOWED_IMPORTS = {
    "requests",
    "yfinance",
    "httpx",
    "aiohttp",
    "urllib3",
    "urllib.request",
    "urllib.parse",
    "websocket",
    "websockets",
    "pandas_datareader",
    "google.auth",
    "google.cloud",
    "boto3",
    "botocore",
    "alpha_vantage",
    "finnhub",
    "polygon",
    "iexfinance",
    "quandl",
    "ccxt",
    "binance",
    "kraken",
    "coinbase",
    "yahooquery",
    "yahoo_financials",
    "stockstats",
    "ta",
    "talib",
    "ta_lib",
    "backtrader",
    "zipline",
    "pytz",
    "timezone",
    "rate_limiter",
    "ratelimit",
    "limits",
    "bucket",
    "tokenbucket",
    "asyncio",
    "concurrent",
    "threading",
    "multiprocessing",
    "queue",
    "redis",
    "celery",
    "rq",
    "dramatiq",
    "kombu",
    "pika",
    "amqp",
    "kafka",
    "kombu",
    "sqlalchemy",
    "psycopg2",
    "psycopg",
    "sqlite3",
    "mysql",
    "postgresql",
    "oracle",
    "mongodb",
    "pymongo",
    "motor",
    "elasticsearch",
    "opensearch",
    "redisearch",
    "whoosh",
    "xapian",
    "sphinx",
    "lucene",
    "solr",
    "algolia",
    "meilisearch",
    "typesense",
    "weaviate",
    "pinecone",
    "chromadb",
    "faiss",
    "annoy",
    "nmslib",
    "hnswlib",
    "scann",
    "scaNN",
    "sift",
    "flann",
    "annoy",
    "pynndescent",
    "umap",
    "tsne",
    "pca",
    "lda",
    "nmf",
    "ica",
    "factor_analysis",
    "gaussian_mixture",
    "bayesian",
    "mcmc",
    "pymc3",
    "pymc4",
    "stan",
    "tensorflow",
    "torch",
    "keras",
    "sklearn",
    "xgboost",
    "lightgbm",
    "catboost",
    "h2o",
    "mlflow",
    "wandb",
    "tensorboard",
    "neptune",
    "comet",
    "weights_biases",
    "sacred",
    "optuna",
    "hyperopt",
    "ray",
    "dask",
    "joblib",
    "loky",
    "concurrent",
    "asyncio",
    "gevent",
    "eventlet",
    "tornado",
    "twisted",
    "asyncpg",
    "aiopg",
    "aiomysql",
    "aiosqlite",
    "motor",
    "beanie",
    "odmantic",
    "tortoise",
    "gino",
    "sqlakeyset",
    "sqlalchemy_utils",
    "alembic",
    "migrate",
    "flyway",
    "liquibase",
    "dbmate",
    "atlas",
    "prisma",
    "drizzle",
    "kysely",
    "supabase",
    "firebase_admin",
    "google.cloud.firestore",
    "google.cloud.storage",
    "google.cloud.bigquery",
    "google.cloud.pubsub",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "aws_lambda",
    "boto3",
    "botocore",
    "moto",
    "localstack",
    "testcontainers",
    "docker",
    "kubernetes",
    "helm",
    "terraform",
    "pulumi",
    "ansible",
    "chef",
    "puppet",
    "salt",
    "fabric",
    "invoke",
    "click",
    "typer",
    "argparse",
    "optparse",
    "configparser",
    "yaml",
    "toml",
    "json",
    "pickle",
    "dill",
    "joblib",
    "shelve",
    "dbm",
    "gdbm",
    "lmdb",
    "leveldb",
    "rocksdb",
    "badgerdb",
    "berkeleydb",
    "sqlite",
    "duckdb",
    "polars",
    "dask",
    "modin",
    "vaex",
    "datatable",
    "pyarrow",
    "feather",
    "parquet",
    "orc",
    "avro",
    "protobuf",
    "msgpack",
    "cbor",
    "bson",
    "pickle",
    "dill",
    "cloudpickle",
    "multiprocessing",
    "concurrent",
    "threading",
    "asyncio",
    "gevent",
    "eventlet",
    "tornado",
    "twisted",
    "aiohttp",
    "httpx",
    "requests",
    "urllib3",
    "urllib",
    "http",
    "socket",
    "ssl",
    "certifi",
    "cryptography",
    "pyopenssl",
    "trustme",
    "idna",
    "charset_normalizer",
    "chardet",
    "email",
    "smtplib",
    "poplib",
    "imaplib",
    "ftplib",
    "telnetlib",
    "socketserver",
    "asyncore",
    "asynchat",
    "socket",
    "ssl",
    "select",
    "selectors",
    "poll",
    "epoll",
    "kqueue",
    "devpoll",
    "inotify",
    "watchdog",
    "pyinotify",
    "watchdog",
    "fsevents",
    "kqueue",
    "poll",
    "select",
    "asyncio",
    "concurrent",
    "threading",
    "multiprocessing",
    "queue",
    "redis",
    "celery",
    "rq",
    "dramatiq",
    "kombu",
    "pika",
    "amqp",
    "kafka",
    "kombu",
    "sqlalchemy",
    "psycopg2",
    "psycopg",
    "sqlite3",
    "mysql",
    "postgresql",
    "oracle",
    "mongodb",
    "pymongo",
    "motor",
    "elasticsearch",
    "opensearch",
    "redisearch",
    "whoosh",
    "xapian",
    "sphinx",
    "lucene",
    "solr",
    "algolia",
    "meilisearch",
    "typesense",
    "weaviate",
    "pinecone",
    "chromadb",
    "faiss",
    "annoy",
    "nmslib",
    "hnswlib",
    "scann",
    "scaNN",
    "sift",
    "flann",
    "annoy",
    "pynndescent",
    "umap",
    "tsne",
    "pca",
    "lda",
    "nmf",
    "ica",
    "factor_analysis",
    "gaussian_mixture",
    "bayesian",
    "mcmc",
    "pymc3",
    "pymc4",
    "stan",
    "tensorflow",
    "torch",
    "keras",
    "sklearn",
    "xgboost",
    "lightgbm",
    "catboost",
    "h2o",
    "mlflow",
    "wandb",
    "tensorboard",
    "neptune",
    "comet",
    "weights_biases",
    "sacred",
    "optuna",
    "hyperopt",
    "ray",
    "dask",
    "joblib",
    "loky",
    "concurrent",
    "asyncio",
    "gevent",
    "eventlet",
    "tornado",
    "twisted",
    "asyncpg",
    "aiopg",
    "aiomysql",
    "aiosqlite",
    "motor",
    "beanie",
    "odmantic",
    "tortoise",
    "gino",
    "sqlakeyset",
    "sqlalchemy_utils",
    "alembic",
    "migrate",
    "flyway",
    "liquibase",
    "dbmate",
    "atlas",
    "prisma",
    "drizzle",
    "kysely",
    "supabase",
    "firebase_admin",
    "google.cloud.firestore",
    "google.cloud.storage",
    "google.cloud.bigquery",
    "google.cloud.pubsub",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "aws_lambda",
    "boto3",
    "botocore",
    "moto",
    "localstack",
    "testcontainers",
    "docker",
    "kubernetes",
    "helm",
    "terraform",
    "pulumi",
    "ansible",
    "chef",
    "puppet",
    "salt",
    "fabric",
    "invoke",
    "click",
    "typer",
    "argparse",
    "optparse",
    "configparser",
    "yaml",
    "toml",
    "json",
    "pickle",
    "dill",
    "joblib",
    "shelve",
    "dbm",
    "gdbm",
    "lmdb",
    "leveldb",
    "rocksdb",
    "badgerdb",
    "berkeleydb",
    "sqlite",
    "duckdb",
    "polars",
    "dask",
    "modin",
    "vaex",
    "datatable",
    "pyarrow",
    "feather",
    "parquet",
    "orc",
    "avro",
    "protobuf",
    "msgpack",
    "cbor",
    "bson",
    "pickle",
    "dill",
    "cloudpickle",
    "multiprocessing",
    "concurrent",
    "threading",
    "asyncio",
    "gevent",
    "eventlet",
    "tornado",
    "twisted",
    "aiohttp",
    "httpx",
    "requests",
    "urllib3",
    "urllib",
    "http",
    "socket",
    "ssl",
    "certifi",
    "cryptography",
    "pyopenssl",
    "trustme",
    "idna",
    "charset_normalizer",
    "chardet",
    "email",
    "smtplib",
    "poplib",
    "imaplib",
    "ftplib",
    "telnetlib",
    "socketserver",
    "asyncore",
    "asynchat",
    "socket",
    "ssl",
    "select",
    "selectors",
    "poll",
    "epoll",
    "kqueue",
    "devpoll",
    "inotify",
    "watchdog",
    "pyinotify",
    "watchdog",
    "fsevents",
    "kqueue",
    "poll",
    "select",
    "asyncio",
    "concurrent",
    "threading",
    "multiprocessing",
    "queue",
    "redis",
    "celery",
    "rq",
    "dramatiq",
    "kombu",
    "pika",
    "amqp",
    "kafka",
    "kombu",
    "sqlalchemy",
    "psycopg2",
    "psycopg",
    "sqlite3",
    "mysql",
    "postgresql",
    "oracle",
    "mongodb",
    "pymongo",
    "motor",
    "elasticsearch",
    "opensearch",
    "redisearch",
    "whoosh",
    "xapian",
    "sphinx",
    "lucene",
    "solr",
    "algolia",
    "meilisearch",
    "typesense",
    "weaviate",
    "pinecone",
    "chromadb",
    "faiss",
    "annoy",
    "nmslib",
    "hnswlib",
    "scann",
    "scaNN",
    "sift",
    "flann",
    "annoy",
    "pynndescent",
    "umap",
    "tsne",
    "pca",
    "lda",
    "nmf",
    "ica",
    "factor_analysis",
    "gaussian_mixture",
    "bayesian",
    "mcmc",
    "pymc3",
    "pymc4",
    "stan",
    "tensorflow",
    "torch",
    "keras",
    "sklearn",
    "xgboost",
    "lightgbm",
    "catboost",
    "h2o",
    "mlflow",
    "wandb",
    "tensorboard",
    "neptune",
    "comet",
    "weights_biases",
    "sacred",
    "optuna",
    "hyperopt",
    "ray",
    "dask",
    "joblib",
    "loky",
    "concurrent",
    "asyncio",
    "gevent",
    "eventlet",
    "tornado",
    "twisted",
    "asyncpg",
    "aiopg",
    "aiomysql",
    "aiosqlite",
    "motor",
    "beanie",
    "odmantic",
    "tortoise",
    "gino",
    "sqlakeyset",
    "sqlalchemy_utils",
    "alembic",
    "migrate",
    "flyway",
    "liquibase",
    "dbmate",
    "atlas",
    "prisma",
    "drizzle",
    "kysely",
    "supabase",
    "firebase_admin",
    "google.cloud.firestore",
    "google.cloud.storage",
    "google.cloud.bigquery",
    "google.cloud.pubsub",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "google.cloud.functions",
    "google.cloud.run",
    "google.cloud.kms",
    "google.cloud.secretmanager",
    "google.cloud.logging",
    "google.cloud.monitoring",
    "google.cloud.trace",
    "google.cloud.error_reporting",
    "google.cloud.iam",
    "google.cloud.resource_manager",
    "google.cloud.compute",
    "google.cloud.container",
    "google.cloud.appengine",
    "aws_lambda",
    "boto3",
    "botocore",
    "moto",
    "localstack",
    "testcontainers",
    "docker",
    "kubernetes",
    "helm",
    "terraform",
    "pulumi",
    "ansible",
    "chef",
    "puppet",
    "salt",
    "fabric",
    "invoke",
    "click",
    "typer",
    "argparse",
    "optparse",
    "configparser",
    "yaml",
    "toml",
    "json",
    "pickle",
    "dill",
    "joblib",
    "shelve",
    "dbm",
    "gdbm",
    "lmdb",
    "leveldb",
    "rocksdb",
    "badgerdb",
    "berkeleydb",
    "sqlite",
    "duckdb",
    "polars",
    "dask",
    "modin",
    "vaex",
    "datatable",
    "pyarrow",
    "feather",
    "parquet",
    "orc",
    "avro",
    "protobuf",
    "msgpack",
    "cbor",
    "bson",
    "pickle",
    "dill",
    "cloudpickle",
}


def _collect_imports(tree: ast.AST) -> Set[str]:
    """Collect top-level import names from an AST."""
    imports = set()
    for node in ast.walk(tree):
        if isinstance(node, ast.Import):
            for alias in node.names:
                imports.add(alias.name.split(".")[0])
        elif isinstance(node, ast.ImportFrom):
            if node.module:
                imports.add(node.module.split(".")[0])
    return imports


def _data_source_files() -> list[Path]:
    """Glob for data_sources/*_source.py files, excluding finnhub_source.py per user request."""
    root = Path(__file__).parent.parent / "app" / "data_sources"
    return [p for p in root.glob("*_source.py") if p.name != "finnhub_source.py"]


@pytest.mark.parametrize("path", _data_source_files())
def test_data_source_no_disallowed_imports(path: Path):
    """Data source thin adapters must not import disallowed modules."""
    source = path.read_text()
    tree = ast.parse(source)
    imports = _collect_imports(tree)

    violations = sorted(imports & DISALLOWED_IMPORTS)
    assert not violations, (
        f"{path.name} imports disallowed modules: {violations}. "
        "Networking/rate limiting/SDKs must live in providers/*. "
        "See app/data_management/ARCHITECTURE.md."
    )


def test_yahoo_and_alpha_vantage_sources_are_thin():
    """Yahoo and Alpha Vantage sources must be thin adapters delegating to provider clients."""
    root = Path(__file__).parent.parent / "app" / "data_sources"
    yahoo_path = root / "yahoo_finance_source.py"
    alpha_path = root / "alphavantage_source.py"

    for path in (yahoo_path, alpha_path):
        assert path.is_file(), f"{path.name} should exist as the thin adapter."

        source = path.read_text()
        # Must contain a client delegation pattern
        assert "self._client" in source or "client" in source, (
            f"{path.name} should delegate to a provider client."
        )
        # Must not contain direct HTTP calls
        assert "requests." not in source and "httpx." not in source and "yfinance." not in source, (
            f"{path.name} should not contain direct HTTP calls."
        )
